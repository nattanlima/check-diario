<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Diário de Operações - Prisme Sales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Cores Prisme */
        .text-prisme { color: #2fc36a; }
        .bg-prisme { background-color: #2fc36a; }
        .bg-prisme-hover:hover { background-color: #25a056; }
        .border-prisme { border-color: #2fc36a; }
        .ring-prisme:focus { --tw-ring-color: #2fc36a; }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .cell-hover:hover { background-color: #ecfdf5 !important; cursor: pointer; transition: background-color 0.2s; } /* Hover verde claro mais forte */
        .task-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        
        /* Badge de pendências */
        .pending-badge {
            background-color: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            margin-left: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
        }

        /* Animação da Sanfona */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-open {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header Fixo -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-20 flex-shrink-0">
        <!-- Linha Superior: Título e Navegação de Data -->
        <div class="px-6 py-3 flex justify-between items-center border-b border-gray-100">
            <div class="flex items-center gap-4">
                <div class="bg-[#2fc36a] text-white p-2 rounded-lg shadow-sm"><i class="fas fa-calendar-check"></i></div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">Operação Diária</h1>
                    <p class="text-xs text-gray-500">Visão Geral de Tarefas</p>
                </div>
            </div>

            <!-- Navegação de Datas Centralizada -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                <button onclick="changeWeek(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition duration-200"><i class="fas fa-chevron-left"></i></button>
                <span id="current-week-label" class="mx-4 font-semibold text-gray-700 min-w-[200px] text-center text-sm">...</span>
                <button onclick="changeWeek(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition duration-200"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="initApp()" class="text-gray-400 hover:text-[#2fc36a] transition p-2" title="Atualizar Dados">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Linha Inferior: Filtros -->
        <div class="px-6 py-3 bg-gray-50 flex flex-wrap gap-4 items-center overflow-x-auto">
            
            <!-- Busca -->
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="text" id="filter-search" oninput="handleFilterChange()" placeholder="Pesquisar empresa..." class="pl-9 pr-3 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-[#2fc36a] focus:border-[#2fc36a] w-64 shadow-sm outline-none">
            </div>

            <!-- Filtro Responsável -->
            <div class="relative">
                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <select id="filter-responsible" onchange="handleFilterChange()" class="pl-9 pr-8 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-[#2fc36a] focus:border-[#2fc36a] shadow-sm bg-white cursor-pointer appearance-none outline-none">
                    <option value="">Todos os Responsáveis</option>
                    <!-- Preenchido via JS -->
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
            </div>

            <!-- Filtro Serviço -->
            <div class="relative">
                <i class="fas fa-tags absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <select id="filter-service" onchange="handleFilterChange()" class="pl-9 pr-8 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-[#2fc36a] focus:border-[#2fc36a] shadow-sm bg-white cursor-pointer appearance-none outline-none">
                    <option value="">Todos os Serviços</option>
                    <option value="TAG-01">Chatbot</option>
                    <option value="TAG-02">Tráfego Pago</option>
                    <option value="TAG-03">Marketing</option>
                    <option value="TAG-04">Vendas</option>
                    <option value="OUTROS">Outros</option>
                </select>
                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
            </div>

            <!-- Botão Limpar -->
            <button onclick="clearFilters()" class="text-xs text-gray-500 hover:text-red-500 font-medium underline px-2">
                Limpar filtros
            </button>
        </div>
    </header>

    <!-- Barra de Alerta / Sanfona -->
    <div id="alert-bar-container" class="hidden bg-red-50 border-b border-red-100 flex-shrink-0">
        <div onclick="toggleAlertAccordion()" class="px-6 py-2 flex justify-between items-center cursor-pointer hover:bg-red-100 transition-colors">
            <div class="flex items-center gap-3 text-red-700">
                <i class="fas fa-exclamation-circle text-lg animate-pulse"></i>
                <span class="font-bold text-sm">Atenção: Existem <span id="alert-count">0</span> tarefas vencidas ou vencendo hoje!</span>
            </div>
            <i id="alert-chevron" class="fas fa-chevron-down text-red-400 transition-transform duration-300"></i>
        </div>
        <div id="alert-content" class="accordion-content bg-white px-6">
            <div id="alert-list" class="py-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                <!-- Injetado via JS -->
            </div>
        </div>
    </div>

    <!-- Main Content (Scrollable) -->
    <main class="flex-grow overflow-y-auto bg-gray-50 p-4 sm:p-6 w-full relative" id="main-container">
        <div id="loader" class="flex flex-col items-center justify-center mt-20">
            <i class="fas fa-spinner fa-spin text-4xl text-[#2fc36a] mb-4"></i>
            <p class="text-gray-500 font-medium">Carregando operações...</p>
        </div>
        <div id="tables-container" class="space-y-8 pb-20 hidden"></div>
        <div id="no-results" class="hidden flex-col items-center justify-center mt-10 text-gray-400">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p>Nenhum resultado encontrado para os filtros selecionados.</p>
        </div>
    </main>

    <!-- MODAL DE TAREFAS/DATA -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header Modal -->
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2" id="modal-client-name">
                        Cliente
                    </h3>
                    <p class="text-sm text-[#2fc36a] font-medium flex items-center gap-2">
                        <i class="far fa-calendar-alt"></i> <span id="modal-date-display">Data</span>
                    </p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200">&times;</button>
            </div>

            <!-- Lista de Tarefas Existentes -->
            <div class="p-6 overflow-y-auto bg-white flex-grow" id="modal-task-list">
                <!-- Injetado via JS -->
            </div>

            <!-- Formulário Nova Tarefa / Edição -->
            <div class="bg-gray-50 p-6 border-t flex-shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-500 uppercase" id="form-title">Adicionar Nova Tarefa</h4>
                    <button id="cancel-edit-btn" onclick="resetForm()" class="hidden text-xs text-red-500 hover:text-red-700 font-semibold bg-red-50 px-2 py-1 rounded">Cancelar Edição</button>
                </div>
                
                <div class="space-y-3">
                    <input type="hidden" id="edit-task-id"> <!-- ID oculto para edição -->
                    <input type="text" id="new-task-title" placeholder="O que precisa ser feito?" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2fc36a] focus:border-[#2fc36a] text-sm shadow-sm transition-all outline-none" autocomplete="off">
                    <div class="flex gap-2">
                        <select id="new-task-responsible" class="p-2.5 border border-gray-300 rounded-lg text-sm flex-1 bg-white shadow-sm focus:ring-2 focus:ring-[#2fc36a] focus:border-[#2fc36a] outline-none">
                            <option value="">Selecione o Responsável</option>
                        </select>
                        <button onclick="handleTaskSubmit()" id="btn-save-task" class="bg-[#2fc36a] hover:bg-[#25a056] text-white px-5 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 shadow-sm whitespace-nowrap">
                            <i class="fas fa-plus" id="btn-icon"></i> <span id="btn-text">Adicionar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 z-50 font-medium text-sm flex items-center gap-2">
        <i class="fas fa-info-circle"></i> <span id="toast-msg"></span>
    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://ccenxfyqwtfpexltuwrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZW54Znlxd3RmcGV4bHR1d3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzE1MTMsImV4cCI6MjA2ODg0NzUxM30.6un31sODuCyd5Dz_pR_kn656k74jjh5CNAfF0YteT7I';
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ESTADO GLOBAL ---
        let appData = { clients: [], tags: [], client_tags: [], tasks: [], users: [] };
        let currentWeekStart = getMonday(new Date()); 
        
        // Estado de Filtro
        let activeFilters = {
            search: '',
            responsible: '',
            service: ''
        };

        // Estado do Modal
        let activeModalClient = null;
        let activeModalDate = null; 
        let isEditing = false; 

        // --- Mapeamento Visual de Serviços ---
        const SERVICE_GROUPS = {
            'TAG-01': { name: 'Chatbot', color: 'blue', icon: 'fa-robot' },
            'TAG-02': { name: 'Tráfego Pago', color: 'green', icon: 'fa-chart-line' },
            'TAG-03': { name: 'Marketing', color: 'purple', icon: 'fa-bullhorn' },
            'TAG-04': { name: 'Vendas', color: 'orange', icon: 'fa-headset' }
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        async function initApp() {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('tables-container').classList.add('hidden');
            document.getElementById('no-results').classList.add('hidden');
            
            await fetchData();
            setupRealtime();
            renderDashboard();
            
            document.getElementById('loader').classList.add('hidden');
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            try {
                const [clientsRes, tagsRes, ctRes, tasksRes, usersRes] = await Promise.all([
                    dbClient.from('clientes').select('*'),
                    dbClient.from('tags').select('*'),
                    dbClient.from('cliente_tags').select('*'),
                    dbClient.from('tarefas').select('*'),
                    dbClient.from('usuarios').select('*')
                ]);

                appData.clients = clientsRes.data || [];
                appData.tags = tagsRes.data || [];
                appData.client_tags = ctRes.data || [];
                appData.tasks = tasksRes.data || [];
                appData.users = usersRes.data || [];

                populateResponsibleSelects();

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showToast("Erro de conexão com o banco de dados.");
            }
        }

        function populateResponsibleSelects() {
            // Filtro Principal
            const filterSelect = document.getElementById('filter-responsible');
            // Modal Select
            const modalSelect = document.getElementById('new-task-responsible');
            
            // Limpa opções atuais (mantendo a primeira)
            while (filterSelect.options.length > 1) filterSelect.remove(1);
            while (modalSelect.options.length > 1) modalSelect.remove(1);

            appData.users.forEach(u => {
                // Filtro
                const optFilter = document.createElement('option');
                optFilter.value = u.id_usuario;
                optFilter.text = u.nome_usuario;
                filterSelect.appendChild(optFilter);

                // Modal
                const optModal = document.createElement('option');
                optModal.value = u.id_usuario;
                optModal.text = u.nome_usuario;
                modalSelect.appendChild(optModal);
            });
        }

        function setupRealtime() {
            dbClient.channel('checklist-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tarefas' }, payload => {
                    handleRealtimeTask(payload);
                })
                .subscribe();
        }

        function handleRealtimeTask(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            if (eventType === 'INSERT') {
                // CORREÇÃO DO BUG: Verificar se já existe (evita duplicação do insert manual)
                const exists = appData.tasks.some(t => t.id_tarefa === newRecord.id_tarefa);
                if (!exists) {
                    appData.tasks.push(newRecord);
                }
            } else if (eventType === 'UPDATE') {
                const idx = appData.tasks.findIndex(t => t.id_tarefa === newRecord.id_tarefa);
                if (idx !== -1) appData.tasks[idx] = newRecord;
            } else if (eventType === 'DELETE') {
                appData.tasks = appData.tasks.filter(t => t.id_tarefa !== oldRecord.id_tarefa);
            }
            renderDashboard(); 
            if (activeModalClient && activeModalDate) {
                renderModalTasks();
            }
        }

        // --- FILTROS ---

        function handleFilterChange() {
            activeFilters.search = document.getElementById('filter-search').value.trim().toLowerCase();
            activeFilters.responsible = document.getElementById('filter-responsible').value;
            activeFilters.service = document.getElementById('filter-service').value;
            renderDashboard();
        }

        function clearFilters() {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-responsible').value = '';
            document.getElementById('filter-service').value = '';
            handleFilterChange();
        }

        function checkClientFilters(client) {
            // 1. Filtro de Pesquisa (Nome)
            if (activeFilters.search) {
                if (!client.nome_empresa.toLowerCase().includes(activeFilters.search)) return false;
            }

            // 2. Filtro de Responsável
            if (activeFilters.responsible) {
                const selectedUser = appData.users.find(u => u.id_usuario == activeFilters.responsible);
                const selectedUserName = selectedUser ? selectedUser.nome_usuario.toLowerCase() : '';
                const clientRespName = (client.nome_responsavel || '').toLowerCase();

                const isAccountOwner = clientRespName.includes(selectedUserName); 
                const hasTasksForUser = appData.tasks.some(t => t.id_cliente === client.id_cliente && t.responsavel_id == activeFilters.responsible);

                if (!isAccountOwner && !hasTasksForUser) return false;
            }

            return true;
        }

        // --- LOGICA DE DATAS ---
        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }
        
        function extractDateISO(dateStr) {
            if (!dateStr) return null;
            return dateStr.split('T')[0];
        }

        function formatDateBr(date) {
            return date.toLocaleDateString('pt-BR');
        }

        function changeWeek(direction) {
            currentWeekStart = addDays(currentWeekStart, direction * 7);
            renderDashboard();
        }

        // --- ALERTA / SANFONA ---
        function toggleAlertAccordion() {
            const content = document.getElementById('alert-content');
            const icon = document.getElementById('alert-chevron');
            
            if (content.classList.contains('accordion-open')) {
                content.classList.remove('accordion-open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('accordion-open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function renderAlertBar() {
            const today = formatDateISO(new Date());
            
            const overdueTasks = appData.tasks.filter(t => {
                if (t.concluido || !t.prazo_final) return false;
                const taskDate = extractDateISO(t.prazo_final);
                return taskDate <= today; 
            });

            const alertContainer = document.getElementById('alert-bar-container');
            const alertCount = document.getElementById('alert-count');
            const alertList = document.getElementById('alert-list');

            if (overdueTasks.length === 0) {
                alertContainer.classList.add('hidden');
                return;
            }

            alertContainer.classList.remove('hidden');
            alertCount.innerText = overdueTasks.length;
            alertList.innerHTML = '';

            const grouped = {};
            overdueTasks.forEach(t => {
                if (!grouped[t.id_cliente]) grouped[t.id_cliente] = [];
                grouped[t.id_cliente].push(t);
            });

            Object.keys(grouped).forEach(clientId => {
                const client = appData.clients.find(c => c.id_cliente == clientId);
                const clientName = client ? client.nome_empresa : 'Cliente Desconhecido';
                const count = grouped[clientId].length;
                const taskDate = extractDateISO(grouped[clientId][0].prazo_final);
                
                const dateParts = taskDate.split('-');
                const displayDate = `${dateParts[2]}/${dateParts[1]}`;
                const isLate = taskDate < today;
                const statusText = isLate ? 'Vencido' : 'Vence Hoje';
                const statusColor = isLate ? 'text-red-700 bg-red-100' : 'text-orange-700 bg-orange-100';

                const card = document.createElement('div');
                card.className = "bg-white border border-red-200 rounded-lg p-3 shadow-sm flex justify-between items-center cursor-pointer hover:bg-red-50 transition";
                card.onclick = () => openDayModal(clientId, taskDate); 

                card.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800 text-sm truncate">${clientName}</p>
                        <p class="text-xs text-gray-500">${count} tarefa(s)</p>
                    </div>
                    <div class="text-xs font-bold px-2 py-1 rounded ${statusColor}">
                        ${statusText} (${displayDate})
                    </div>
                `;
                alertList.appendChild(card);
            });
        }

        // --- RENDERIZAÇÃO DASHBOARD ---
        function renderDashboard() {
            renderAlertBar(); 

            const container = document.getElementById('tables-container');
            const noResults = document.getElementById('no-results');
            container.innerHTML = '';

            const weekDays = [];
            const headerDaysHtml = [];
            const daysNames = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'];
            
            for(let i=0; i<5; i++) {
                const dayDate = addDays(currentWeekStart, i);
                const isoDate = formatDateISO(dayDate);
                weekDays.push(isoDate);
                
                // DESTAQUE PARA HOJE: Fundo diferente, texto Prisme e borda mais grossa
                const isToday = isoDate === formatDateISO(new Date());
                const bgClass = isToday ? 'bg-[#f0fdf4] text-[#2fc36a] border-b-4 border-[#2fc36a] font-bold' : 'bg-gray-50 text-gray-500 font-medium';

                headerDaysHtml.push(`
                    <th class="px-2 py-3 text-center text-xs uppercase tracking-wider border-l border-gray-200 ${bgClass} w-32">
                        ${daysNames[i]} <br> <span class="text-[10px] opacity-75 font-normal">${dayDate.getDate()}/${dayDate.getMonth()+1}</span>
                    </th>
                `);
            }

            const startLabel = formatDateBr(currentWeekStart);
            const endLabel = formatDateBr(addDays(currentWeekStart, 4));
            document.getElementById('current-week-label').innerText = `Semana: ${startLabel} a ${endLabel}`;

            const groupedData = {};
            Object.keys(SERVICE_GROUPS).forEach(key => groupedData[key] = []);
            groupedData['OUTROS'] = [];
            const tagMap = {}; 
            appData.tags.forEach(t => tagMap[t.id_tag] = t);

            let hasAnyResult = false;

            appData.clients.forEach(client => {
                const status = (client.status || '').toLowerCase();
                if (status.includes('cancelado')) return;

                if (!checkClientFilters(client)) return;

                const clientTags = appData.client_tags.filter(ct => ct.id_cliente === client.id_cliente);
                let addedToGroup = false;

                if (clientTags.length > 0) {
                    clientTags.forEach(ct => {
                        const tagObj = tagMap[ct.id_tag];
                        if (tagObj) {
                            let groupKey = 'OUTROS';
                            const tagNameUpper = (tagObj.nome_tag || '').toUpperCase();
                            const tagIdStr = (tagObj.id_tag || '').toString();

                            if (SERVICE_GROUPS[tagIdStr]) groupKey = tagIdStr;
                            else if (tagNameUpper.includes('CHATBOT')) groupKey = 'TAG-01';
                            else if (tagNameUpper.includes('TRÁFEGO') || tagNameUpper.includes('TRAFEGO')) groupKey = 'TAG-02';
                            else if (tagNameUpper.includes('MARKETING')) groupKey = 'TAG-03';
                            else if (tagNameUpper.includes('VENDA')) groupKey = 'TAG-04';

                            if (!groupedData[groupKey]) groupedData[groupKey] = [];
                            const exists = groupedData[groupKey].find(c => c.id_cliente === client.id_cliente);
                            if(!exists) {
                                groupedData[groupKey].push(client);
                                addedToGroup = true;
                            }
                        }
                    });
                } 
                if (!addedToGroup) {
                    const exists = groupedData['OUTROS'].find(c => c.id_cliente === client.id_cliente);
                    if(!exists) groupedData['OUTROS'].push(client);
                }
            });

            // Gerar HTML
            Object.keys(groupedData).forEach(groupKey => {
                if (activeFilters.service && activeFilters.service !== groupKey) return;

                const clientsList = groupedData[groupKey];
                if (clientsList.length === 0) return;

                hasAnyResult = true;

                const meta = SERVICE_GROUPS[groupKey] || { name: 'Outros Serviços', color: 'gray', icon: 'fa-folder' };
                clientsList.sort((a,b) => a.nome_empresa.localeCompare(b.nome_empresa));

                let rowsHtml = '';
                clientsList.forEach((client, idx) => {
                    const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    const totalPending = appData.tasks.filter(t => t.id_cliente === client.id_cliente && !t.concluido).length;
                    const badgeHtml = totalPending > 0 
                        ? `<span class="pending-badge" title="${totalPending} tarefas pendentes no total">${totalPending}</span>` 
                        : '';

                    let daysCells = '';
                    weekDays.forEach(dateStr => {
                        const tasksForDay = appData.tasks.filter(t => 
                            t.id_cliente === client.id_cliente && 
                            extractDateISO(t.prazo_final) === dateStr
                        );

                        // DESTAQUE DA COLUNA DE HOJE: Aplica bg-[#f0fdf4] (verde bem claro) se for o dia de hoje
                        const isToday = dateStr === formatDateISO(new Date());
                        const cellBgClass = isToday ? 'bg-[#f0fdf4]' : '';

                        let content = '';
                        if (tasksForDay.length > 0) {
                            const completedCount = tasksForDay.filter(t => t.concluido).length;
                            const total = tasksForDay.length;
                            const allDone = completedCount === total;
                            
                            // Cores das células: verde para tudo pronto, verde claro para parcial
                            let colorClass = allDone ? 'bg-[#2fc36a] text-white border-[#2fc36a]' : 'bg-[#e6f9ed] text-[#2fc36a] border-[#2fc36a]';
                            if (total > 0 && completedCount === 0) colorClass = 'bg-orange-100 text-orange-700 border-orange-200';

                            content = `
                                <div class="w-full h-full p-1 rounded border ${colorClass} text-xs font-semibold flex flex-col items-center justify-center gap-1 shadow-sm relative group-hover:scale-[1.02] transition-transform">
                                    <span>${completedCount}/${total}</span>
                                    <div class="flex flex-wrap justify-center gap-0.5 max-w-full">
                                        ${tasksForDay.slice(0,4).map(t => `<span class="task-dot ${t.concluido ? 'bg-white' : 'bg-orange-400'}"></span>`).join('')}
                                        ${tasksForDay.length > 4 ? '<span class="text-[8px] leading-none">+</span>' : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            content = `<div class="w-full h-full flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity"><i class="fas fa-plus text-gray-300 text-sm"></i></div>`;
                        }

                        daysCells += `
                            <td onclick="openDayModal('${client.id_cliente}', '${dateStr}')" 
                                class="border-l border-gray-100 p-1 h-16 cell-hover align-middle relative ${cellBgClass}">
                                ${content}
                            </td>
                        `;
                    });

                    const wppUrl = client.whatsapp ? `https://wa.me/${client.whatsapp.replace(/\D/g,'')}` : '#';
                    const wppIcon = client.whatsapp ? `<a href="${wppUrl}" target="_blank" class="text-[#2fc36a] hover:text-[#25a056] p-1" onclick="event.stopPropagation()"><i class="fab fa-whatsapp text-lg"></i></a>` : '';

                    rowsHtml += `
                        <tr class="${rowClass} hover:bg-green-50 transition-colors group">
                            <td class="px-6 py-4 whitespace-nowrap border-l-4 border-transparent hover:border-${meta.color}-500 transition-all">
                                <div class="flex items-center">
                                    <div class="text-sm font-bold text-gray-900 truncate max-w-[200px]" title="${client.nome_empresa}">${client.nome_empresa}</div>
                                    ${badgeHtml}
                                </div>
                                <div class="text-xs text-gray-500 mt-0.5 truncate max-w-[200px]">${client.nome_responsavel || ''}</div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-center">
                                ${wppIcon}
                            </td>
                            ${daysCells}
                        </tr>
                    `;
                });

                const section = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                        <div class="px-6 py-3 border-b border-gray-200 bg-gray-50 flex items-center gap-3">
                            <div class="bg-${meta.color}-100 text-${meta.color}-600 p-2 rounded-lg shadow-sm">
                                <i class="fas ${meta.icon}"></i>
                            </div>
                            <h2 class="text-lg font-bold text-gray-800">${meta.name}</h2>
                            <span class="bg-white border text-gray-500 text-xs px-2 py-1 rounded-full font-medium shadow-sm">${clientsList.length}</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Empresa</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Wpp</th>
                                        ${headerDaysHtml.join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.innerHTML += section;
            });

            if (hasAnyResult) {
                container.classList.remove('hidden');
                noResults.classList.add('hidden');
            } else {
                container.classList.add('hidden');
                noResults.classList.remove('hidden');
                noResults.style.display = 'flex';
            }
        }

        // --- MODAL & TASK LOGIC ---
        function openDayModal(clientId, dateStr) {
            const client = appData.clients.find(c => c.id_cliente == clientId);
            if (!client) return;

            activeModalClient = client;
            activeModalDate = dateStr;
            resetForm(); 

            document.getElementById('modal-client-name').innerHTML = `<i class="fas fa-building text-gray-400"></i> ${client.nome_empresa}`;
            
            const parts = dateStr.split('-');
            const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
            const dateFormatted = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('modal-date-display').innerText = dateFormatted.charAt(0).toUpperCase() + dateFormatted.slice(1);

            document.getElementById('task-modal').classList.remove('hidden');
            renderModalTasks();
        }

        function closeModal() {
            document.getElementById('task-modal').classList.add('hidden');
            activeModalClient = null;
            activeModalDate = null;
            resetForm();
        }

        function renderModalTasks() {
            const listContainer = document.getElementById('modal-task-list');
            listContainer.innerHTML = '';

            const tasks = appData.tasks.filter(t => 
                t.id_cliente == activeModalClient.id_cliente && 
                extractDateISO(t.prazo_final) === activeModalDate
            );

            if (tasks.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <div class="bg-gray-100 p-4 rounded-full mb-3">
                            <i class="fas fa-check-double text-2xl text-gray-300"></i>
                        </div>
                        <p class="text-sm font-medium">Tudo limpo por aqui!</p>
                        <p class="text-xs">Nenhuma tarefa para este dia.</p>
                    </div>
                `;
            } else {
                tasks.forEach(task => {
                    const resp = appData.users.find(u => u.id_usuario == task.responsavel_id);
                    
                    // Lógica para Foto ou Iniciais
                    let avatarHtml = '';
                    if (resp && resp.foto_url) {
                        avatarHtml = `<img src="${resp.foto_url}" class="w-6 h-6 rounded-full object-cover border border-gray-200 shadow-sm" title="${resp.nome_usuario}" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex'">`;
                        // Fallback hidden inicialmente
                        const respName = resp.nome_usuario;
                        const initials = respName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                        avatarHtml += `<span class="hidden w-6 h-6 items-center justify-center text-[10px] bg-gray-100 text-gray-600 rounded-full border border-gray-200 font-medium" title="${respName}">${initials}</span>`;
                    } else {
                        const respName = resp ? resp.nome_usuario : 'Sem dono';
                        const initials = respName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                        avatarHtml = `<span class="w-6 h-6 inline-flex items-center justify-center text-[10px] bg-gray-100 text-gray-600 rounded-full border border-gray-200 font-medium" title="${respName}">${initials}</span>`;
                    }
                    
                    const div = document.createElement('div');
                    div.className = `group flex items-start justify-between p-3 mb-2 rounded-lg border transition-all ${task.concluido ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:border-[#2fc36a] hover:shadow-sm'}`;
                    
                    div.innerHTML = `
                        <div class="flex items-start gap-3 flex-grow">
                            <div class="relative flex items-center justify-center mt-1">
                                <input type="checkbox" onchange="toggleTask('${task.id_tarefa}', this.checked)" ${task.concluido ? 'checked' : ''} class="peer h-5 w-5 text-[#2fc36a] rounded border-gray-300 focus:ring-[#2fc36a] cursor-pointer transition-transform transform active:scale-90">
                            </div>
                            <div class="flex-grow min-w-0">
                                <p class="text-sm font-medium text-gray-800 break-words ${task.concluido ? 'line-through text-gray-500' : ''}">${task.titulo_tarefa}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    ${avatarHtml}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="startEditTask('${task.id_tarefa}')" class="p-1.5 text-gray-400 hover:text-[#2fc36a] hover:bg-green-50 rounded-md transition" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="deleteTask('${task.id_tarefa}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
        }

        // --- EDICAO & CRUD TAREFAS ---

        function resetForm() {
            isEditing = false;
            document.getElementById('edit-task-id').value = '';
            document.getElementById('new-task-title').value = '';
            document.getElementById('new-task-responsible').value = '';
            
            // UI Reset
            document.getElementById('form-title').innerText = 'Adicionar Nova Tarefa';
            document.getElementById('btn-text').innerText = 'Adicionar';
            document.getElementById('btn-icon').className = 'fas fa-plus';
            document.getElementById('btn-save-task').classList.remove('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('btn-save-task').classList.add('bg-[#2fc36a]', 'hover:bg-[#25a056]');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        function startEditTask(taskId) {
            const task = appData.tasks.find(t => t.id_tarefa == taskId);
            if(!task) return;

            isEditing = true;
            document.getElementById('edit-task-id').value = task.id_tarefa;
            document.getElementById('new-task-title').value = task.titulo_tarefa;
            document.getElementById('new-task-responsible').value = task.responsavel_id || '';

            // UI Update
            document.getElementById('form-title').innerText = 'Editando Tarefa';
            document.getElementById('btn-text').innerText = 'Salvar Edição';
            document.getElementById('btn-icon').className = 'fas fa-save';
            document.getElementById('btn-save-task').classList.remove('bg-[#2fc36a]', 'hover:bg-[#25a056]');
            document.getElementById('btn-save-task').classList.add('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');

            document.getElementById('new-task-title').focus();
        }

        async function handleTaskSubmit() {
            if(isEditing) {
                await updateTask();
            } else {
                await createTask();
            }
        }

        async function updateTask() {
            const taskId = document.getElementById('edit-task-id').value;
            const title = document.getElementById('new-task-title').value.trim();
            const respId = document.getElementById('new-task-responsible').value;

            if (!title) { showToast("O título é obrigatório."); return; }

            const btn = document.getElementById('btn-save-task');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Optimistic Update
                const taskIdx = appData.tasks.findIndex(t => t.id_tarefa == taskId);
                if(taskIdx !== -1) {
                    appData.tasks[taskIdx].titulo_tarefa = title;
                    appData.tasks[taskIdx].responsavel_id = respId || null;
                    renderModalTasks(); // Update UI immediately
                }

                const { error } = await dbClient.from('tarefas').update({
                    titulo_tarefa: title,
                    responsavel_id: respId || null
                }).eq('id_tarefa', taskId);

                if (error) throw error;
                
                showToast("Tarefa atualizada!");
                resetForm();

            } catch (err) {
                console.error(err);
                showToast("Erro ao atualizar tarefa.");
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function createTask() {
            const titleInput = document.getElementById('new-task-title');
            const respInput = document.getElementById('new-task-responsible');
            
            const title = titleInput.value.trim();
            const respId = respInput.value;

            if (!title) { showToast("Digite o título da tarefa."); return; }

            const btn = document.getElementById('btn-save-task');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const uniqueId = `TSK-${Date.now()}`; 
                const newTask = {
                    id_tarefa: uniqueId,
                    id_cliente: activeModalClient.id_cliente,
                    titulo_tarefa: title,
                    responsavel_id: respId || null,
                    prazo_final: activeModalDate, 
                    concluido: false,
                    ordem: 0
                };

                const { error } = await dbClient.from('tarefas').insert([newTask]);
                if (error) throw error;
                
                titleInput.value = '';
                showToast("Tarefa criada!");
                
                if(!appData.tasks.some(t => t.id_tarefa === uniqueId)) {
                    appData.tasks.push(newTask);
                }
                
                renderModalTasks();
                renderDashboard(); 

            } catch (err) {
                console.error(err);
                showToast("Erro ao criar tarefa.");
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function toggleTask(taskId, completed) {
            // Optimistic update
            const task = appData.tasks.find(t => t.id_tarefa == taskId);
            if(task) task.concluido = completed;
            renderModalTasks();
            renderDashboard(); 

            const { error } = await dbClient.from('tarefas').update({ concluido: completed }).eq('id_tarefa', taskId);
            if(error) {
                showToast("Erro de conexão.");
                if(task) task.concluido = !completed;
                renderModalTasks();
            }
        }

        async function deleteTask(taskId) {
            if(!confirm("Tem certeza que deseja excluir esta tarefa?")) return;

            // Optimistic
            appData.tasks = appData.tasks.filter(t => t.id_tarefa != taskId);
            renderModalTasks();
            renderDashboard();

            const { error } = await dbClient.from('tarefas').delete().eq('id_tarefa', taskId);
            if(error) {
                showToast("Erro ao excluir.");
                await fetchData(); 
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-2'), 3000);
        }
    </script>
</body>
</html>
